{% extends "base.html" %}

{% block title %}Leave Management - HRMS{% endblock %}

{% block content %}
<div class="min-h-screen">
    <!-- Header -->
    <div class="bg-gradient-to-br from-white/10 to-white/5 backdrop-blur-xl border-b border-white/10 shadow-lg glass-highlight">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="animate-fade-in">
                    <p class="text-sm uppercase tracking-wide text-primary-300 mb-1">Employee Portal</p>
                    <h1 class="text-3xl font-bold text-white">Leave Management</h1>
                    <p class="text-gray-300">Apply for leave and track your requests effortlessly.</p>
                </div>
                <div class="flex items-center space-x-3">
                    <span class="px-4 py-2 rounded-full bg-white/10 text-white border border-white/10 backdrop-blur-sm">
                        <i class="fas fa-calendar-alt mr-2"></i>
                        <span id="current-date"></span>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Tab Navigation -->
        <div class="rounded-2xl bg-gradient-to-br from-white/10 to-white/5 backdrop-blur-xl border border-white/10 shadow-lg glass-highlight mb-6">
            <div class="border-b border-white/10">
                <nav class="flex -mb-px">
                    <button onclick="switchTab('apply')" id="tab-apply" 
                        class="tab-btn px-8 py-4 text-sm font-medium border-b-2 border-primary-500 text-primary-300 transition-colors">
                        <i class="fas fa-paper-plane mr-2"></i>Apply for Leave
                    </button>
                    <button onclick="switchTab('history')" id="tab-history" 
                        class="tab-btn px-8 py-4 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-gray-200 hover:border-white/20 transition-colors">
                        <i class="fas fa-history mr-2"></i>My Leave Requests
                    </button>
                </nav>
            </div>
        </div>

        <!-- Apply for Leave Tab -->
        <div id="content-apply" class="tab-content">
            <div class="rounded-2xl p-8 bg-gradient-to-br from-white/10 to-white/5 backdrop-blur-xl border border-white/10 shadow-lg glass-highlight">
                <h2 class="text-2xl font-bold text-white mb-6">Apply for Leave</h2>
                
                <form id="leaveForm" class="space-y-6">
                    <!-- Leave Type -->
                    <div>
                        <label for="leave_type" class="block text-sm font-medium text-gray-300 mb-2">
                            Leave Type <span class="text-red-400">*</span>
                        </label>
                        <select id="leave_type" name="leave_type" required
                            class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent backdrop-blur-sm">
                            <option value="" class="bg-gray-800">Select leave type</option>
                            <option value="Paid Leave" class="bg-gray-800">Paid Leave</option>
                            <option value="Sick Leave" class="bg-gray-800">Sick Leave</option>
                            <option value="Unpaid Leave" class="bg-gray-800">Unpaid Leave</option>
                        </select>
                    </div>

                    <!-- Date Range -->
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label for="start_date" class="block text-sm font-medium text-gray-300 mb-2">
                                Start Date <span class="text-red-400">*</span>
                            </label>
                            <input type="date" id="start_date" name="start_date" required
                                class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent backdrop-blur-sm">
                        </div>
                        <div>
                            <label for="end_date" class="block text-sm font-medium text-gray-300 mb-2">
                                End Date <span class="text-red-400">*</span>
                            </label>
                            <input type="date" id="end_date" name="end_date" required
                                class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent backdrop-blur-sm">
                        </div>
                    </div>

                    <!-- Total Days Display -->
                    <div id="total-days-display" class="hidden bg-primary-500/10 border border-primary-500/30 rounded-lg p-4 backdrop-blur-sm">
                        <p class="text-primary-200 font-medium">
                            <i class="fas fa-calendar-check mr-2"></i>
                            Total Leave Days: <span id="total-days-value" class="font-bold text-white">0</span>
                        </p>
                    </div>

                    <!-- Reason -->
                    <div>
                        <label for="reason" class="block text-sm font-medium text-gray-300 mb-2">
                            Reason / Remarks <span class="text-red-400">*</span>
                        </label>
                        <textarea id="reason" name="reason" rows="4" maxlength="250" required
                            placeholder="Please provide a reason for your leave request..."
                            class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-primary-500 focus:border-transparent resize-none backdrop-blur-sm"></textarea>
                        <div class="flex justify-between mt-2">
                            <p class="text-sm text-gray-400">Maximum 250 characters</p>
                            <p class="text-sm text-gray-400">
                                <span id="char-count" class="text-white font-medium">0</span>/250
                            </p>
                        </div>
                    </div>

                    <!-- Error Message -->
                    <div id="form-error" class="hidden bg-red-500/10 border border-red-500/30 rounded-lg p-4 backdrop-blur-sm">
                        <p class="text-red-200">
                            <i class="fas fa-exclamation-circle mr-2"></i>
                            <span id="error-message"></span>
                        </p>
                    </div>

                    <!-- Submit Button -->
                    <div class="flex justify-end space-x-4">
                        <button type="button" onclick="resetForm()" 
                            class="px-6 py-3 bg-white/5 border border-white/10 text-gray-300 rounded-lg hover:bg-white/10 transition-colors backdrop-blur-sm">
                            Reset
                        </button>
                        <button type="submit" id="submit-btn"
                            class="px-8 py-3 bg-gradient-to-r from-primary-500 to-primary-600 text-white rounded-lg hover:brightness-110 transition-all disabled:opacity-40 disabled:cursor-not-allowed shadow-lg shadow-primary-500/20">
                            <span id="submit-text">
                                <i class="fas fa-paper-plane mr-2"></i>Apply Leave
                            </span>
                            <span id="submit-loader" class="hidden">
                                <i class="fas fa-spinner fa-spin mr-2"></i>Submitting...
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- My Leave Requests Tab -->
        <div id="content-history" class="tab-content hidden">
            <div class="rounded-2xl p-8 bg-gradient-to-br from-white/10 to-white/5 backdrop-blur-xl border border-white/10 shadow-lg glass-highlight">
                <h2 class="text-2xl font-bold text-white mb-6">My Leave Requests</h2>
                
                <!-- Loading State -->
                <div id="history-loading" class="text-center py-12">
                    <i class="fas fa-spinner fa-spin text-4xl text-primary-400 mb-4"></i>
                    <p class="text-gray-300">Loading your leave requests...</p>
                </div>

                <!-- Empty State -->
                <div id="history-empty" class="hidden text-center py-12">
                    <div class="mb-4">
                        <i class="fas fa-calendar-times text-6xl text-gray-600"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-white mb-2">No Leave Requests Yet</h3>
                    <p class="text-gray-400 mb-6">You haven't applied for any leave yet.</p>
                    <button onclick="switchTab('apply')" 
                        class="px-6 py-3 bg-gradient-to-r from-primary-500 to-primary-600 text-white rounded-lg hover:brightness-110 transition-all shadow-lg shadow-primary-500/20">
                        <i class="fas fa-plus mr-2"></i>Apply for Leave
                    </button>
                </div>

                <!-- Leave Requests Table -->
                <div id="history-table" class="hidden overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr class="border-b border-white/10">
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Leave Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Date Range</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Total Days</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Applied On</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Remarks</th>
                            </tr>
                        </thead>
                        <tbody id="leave-tbody" class="divide-y divide-white/10">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success Toast -->
<div id="success-toast" class="hidden fixed top-4 right-4 z-50 bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-4 rounded-lg shadow-xl transform transition-all duration-300 backdrop-blur-sm border border-green-400/30">
    <div class="flex items-center">
        <i class="fas fa-check-circle text-2xl mr-3"></i>
        <div>
            <p class="font-semibold">Success!</p>
            <p id="toast-message" class="text-sm text-green-100"></p>
        </div>
    </div>
</div>

<script>
// Tab Switching
function switchTab(tab) {
    // Update tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('border-primary-500', 'text-primary-300');
        btn.classList.add('border-transparent', 'text-gray-400');
    });
    
    // Update content
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    // Activate selected tab
    document.getElementById(`tab-${tab}`).classList.remove('border-transparent', 'text-gray-400');
    document.getElementById(`tab-${tab}`).classList.add('border-primary-500', 'text-primary-300');
    document.getElementById(`content-${tab}`).classList.remove('hidden');
    
    // Load history when switching to history tab
    if (tab === 'history') {
        loadLeaveHistory();
    }
}

// Set minimum date to today
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    const leaveTypeSelect = document.getElementById('leave_type');
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    
    // Initially set min date to today
    startDateInput.setAttribute('min', today);
    endDateInput.setAttribute('min', today);
    
    // Update current date
    const dateOptions = { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' };
    document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-US', dateOptions);
    
    // Update character count
    const reasonTextarea = document.getElementById('reason');
    reasonTextarea.addEventListener('input', function() {
        document.getElementById('char-count').textContent = this.value.length;
    });
    
    // Handle leave type change
    leaveTypeSelect.addEventListener('change', function() {
        const leaveType = this.value;
        
        if (leaveType === 'Sick Leave') {
            // Sick leave can be for past or today, but not future
            startDateInput.removeAttribute('min');
            endDateInput.removeAttribute('min');
            startDateInput.setAttribute('max', today);
            endDateInput.setAttribute('max', today);
        } else {
            // Other leave types can only be today or future
            startDateInput.removeAttribute('max');
            endDateInput.removeAttribute('max');
            startDateInput.setAttribute('min', today);
            endDateInput.setAttribute('min', today);
        }
        
        // Reset date fields when leave type changes
        startDateInput.value = '';
        endDateInput.value = '';
        hideError();
        document.getElementById('total-days-display').classList.add('hidden');
    });
    
    // Calculate total days on date change
    startDateInput.addEventListener('change', calculateTotalDays);
    endDateInput.addEventListener('change', calculateTotalDays);
});

// Calculate total leave days
function calculateTotalDays() {
    const startDate = document.getElementById('start_date').value;
    const endDate = document.getElementById('end_date').value;
    
    if (startDate && endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        
        if (end >= start) {
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            
            document.getElementById('total-days-value').textContent = diffDays;
            document.getElementById('total-days-display').classList.remove('hidden');
            hideError();
        } else {
            showError('End date cannot be before start date');
            document.getElementById('total-days-display').classList.add('hidden');
        }
    }
}

// Form submission
document.getElementById('leaveForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Validate form
    const leaveType = document.getElementById('leave_type').value;
    const startDate = document.getElementById('start_date').value;
    const endDate = document.getElementById('end_date').value;
    const reason = document.getElementById('reason').value.trim();
    
    if (!leaveType || !startDate || !endDate || !reason) {
        showError('All fields are required');
        return;
    }
    
    // Validate dates
    const start = new Date(startDate);
    const end = new Date(endDate);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    // Sick leave cannot be for future dates
    if (leaveType === 'Sick Leave' && start > today) {
        showError('Sick leave cannot be applied for future dates');
        return;
    }
    
    // Other leave types cannot be for past dates
    if (leaveType !== 'Sick Leave' && start < today) {
        showError('Cannot apply leave for past dates');
        return;
    }
    
    if (end < start) {
        showError('End date cannot be before start date');
        return;
    }
    
    // Show loading state
    const submitBtn = document.getElementById('submit-btn');
    submitBtn.disabled = true;
    document.getElementById('submit-text').classList.add('hidden');
    document.getElementById('submit-loader').classList.remove('hidden');
    hideError();
    
    try {
        const response = await fetch('/employee/leave/apply', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                leave_type: leaveType,
                start_date: startDate,
                end_date: endDate,
                reason: reason
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Show success toast
            showSuccessToast(data.message);
            
            // Reset form
            resetForm();
            
            // Switch to history tab after 1.5 seconds
            setTimeout(() => {
                switchTab('history');
            }, 1500);
        } else {
            showError(data.message);
        }
    } catch (error) {
        showError('Network error. Please check your connection and try again.');
        console.error('Error:', error);
    } finally {
        // Reset button state
        submitBtn.disabled = false;
        document.getElementById('submit-text').classList.remove('hidden');
        document.getElementById('submit-loader').classList.add('hidden');
    }
});

// Load leave history
async function loadLeaveHistory() {
    const loading = document.getElementById('history-loading');
    const empty = document.getElementById('history-empty');
    const table = document.getElementById('history-table');
    
    loading.classList.remove('hidden');
    empty.classList.add('hidden');
    table.classList.add('hidden');
    
    try {
        const response = await fetch('/employee/leave/history');
        const data = await response.json();
        
        if (data.success && data.leaves.length > 0) {
            renderLeaveHistory(data.leaves);
            loading.classList.add('hidden');
            table.classList.remove('hidden');
        } else {
            loading.classList.add('hidden');
            empty.classList.remove('hidden');
        }
    } catch (error) {
        console.error('Error loading leave history:', error);
        loading.classList.add('hidden');
        empty.classList.remove('hidden');
    }
}

// Render leave history table
function renderLeaveHistory(leaves) {
    const tbody = document.getElementById('leave-tbody');
    tbody.innerHTML = '';
    
    leaves.forEach(leave => {
        const statusBadge = getStatusBadge(leave.status);
        const dateRange = formatDateRange(leave.start_date, leave.end_date);
        
        const row = document.createElement('tr');
        row.className = 'hover:bg-white/5 transition-colors';
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                    <i class="fas fa-calendar-alt text-primary-400 mr-2"></i>
                    <span class="text-sm font-medium text-white">${leave.leave_type}</span>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${dateRange}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                <span class="font-semibold text-white">${leave.total_days}</span> day${leave.total_days > 1 ? 's' : ''}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">${leave.applied_on}</td>
            <td class="px-6 py-4">
                <div class="text-sm text-gray-300 max-w-xs truncate" title="${leave.reason}">
                    ${leave.reason}
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Get status badge HTML
function getStatusBadge(status) {
    const badges = {
        'Pending': '<span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-500/20 border border-yellow-400/30 text-yellow-200"><i class="fas fa-clock mr-1"></i> Pending</span>',
        'Approved': '<span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-500/20 border border-green-400/30 text-green-200"><i class="fas fa-check-circle mr-1"></i> Approved</span>',
        'Rejected': '<span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-500/20 border border-red-400/30 text-red-200"><i class="fas fa-times-circle mr-1"></i> Rejected</span>'
    };
    return badges[status] || status;
}

// Format date range
function formatDateRange(startDate, endDate) {
    const options = { month: 'short', day: 'numeric', year: 'numeric' };
    const start = new Date(startDate).toLocaleDateString('en-US', options);
    const end = new Date(endDate).toLocaleDateString('en-US', options);
    return `${start} â†’ ${end}`;
}

// Show error message
function showError(message) {
    document.getElementById('error-message').textContent = message;
    document.getElementById('form-error').classList.remove('hidden');
    document.getElementById('form-error').scrollIntoView({ behavior: 'smooth', block: 'center' });
}

// Hide error message
function hideError() {
    document.getElementById('form-error').classList.add('hidden');
}

// Show success toast
function showSuccessToast(message) {
    const toast = document.getElementById('success-toast');
    document.getElementById('toast-message').textContent = message;
    toast.classList.remove('hidden');
    
    setTimeout(() => {
        toast.classList.add('hidden');
    }, 3000);
}

// Reset form
function resetForm() {
    document.getElementById('leaveForm').reset();
    document.getElementById('char-count').textContent = '0';
    document.getElementById('total-days-display').classList.add('hidden');
    hideError();
}
</script>
{% endblock %}
